#' Write chromcall 2-sample comparison results to file
#'
#' @description
#' Converts the result of [compare_samples()] — a [`GRanges`] object containing
#' differential region-level statistics — into a `data.frame` and writes it to a
#' tab-delimited `.tsv` file. The `strand` column is removed (if present), and
#' the chromosome column is renamed to "chr" for consistency.
#'
#' The function also attempts to order columns in a readable way:
#' genomic coordinates → sample1 expression + metrics → sample2 expression + metrics →
#' expression log2FC (if present) → delta metrics → any remaining columns.
#'
#' @param x A [`GRanges`] object generated by [compare_samples()].
#' @param file Output file path (should end in `.tsv`).
#'
#' @return A `data.frame` invisibly, also written to `file`.
#'
#' @examples
#' ## Control-mode (ChIP/CUT&RUN-style): compare two tested samples and export
#' genome_file <- system.file("extdata", "genome.txt", package = "chromcall")
#' region_file <- system.file("extdata", "example.bed", package = "chromcall")
#' blacklist_file <- system.file("extdata", "blacklist.bed", package = "chromcall")
#' expr_file <- system.file("extdata", "expression_tss.bed", package = "chromcall")
#'
#' sampleA <- build_chromcall_sample(
#'   sample_name     = "sampleA",
#'   experiments     = list(
#'     H3K4me3  = system.file("extdata", "h3k4me3_sampleA.bam", package = "chromcall"),
#'     Control = system.file("extdata", "control_sampleA.bam", package = "chromcall")
#'   ),
#'   control_name    = "Control",
#'   genome_file     = genome_file,
#'   region_file     = region_file,
#'   window_size     = 10000,
#'   blacklist_file  = blacklist_file,
#'   expression_file = expr_file
#' )
#'
#' sampleB <- build_chromcall_sample(
#'   sample_name     = "sampleB",
#'   experiments     = list(
#'     H3K4me3  = system.file("extdata", "h3k4me3_sampleB.bam", package = "chromcall"),
#'     Control = system.file("extdata", "control_sampleB.bam", package = "chromcall")
#'   ),
#'   control_name    = "Control",
#'   genome_file     = genome_file,
#'   region_file     = region_file,
#'   window_size     = 10000,
#'   blacklist_file  = blacklist_file,
#'   expression_file = expr_file
#' )
#'
#' resA <- test_region_counts(sampleA)
#' resB <- test_region_counts(sampleB)
#' cmp <- compare_samples(resA, resB, experiments = "H3K4me3", threshold = 0.05)
#'
#' out_file <- tempfile(fileext = ".tsv")
#' write_comparison_results(cmp, out_file)
#' read.table(out_file, header = TRUE)
#'
#' ## No-control mode (ATAC-seq-style): export still works
#' # Note: we use package example BAMs here for demonstration only.
#' atacA <- build_chromcall_sample(
#'   sample_name     = "ATAC_A",
#'   experiments     = list(
#'     ATAC = system.file("extdata", "h3k27me3_sampleA.bam", package = "chromcall")
#'   ),
#'   control_name    = NULL,
#'   genome_file     = genome_file,
#'   region_file     = region_file,
#'   window_size     = 10000,
#'   blacklist_file  = blacklist_file,
#'   expression_file = expr_file
#' )
#'
#' atacB <- build_chromcall_sample(
#'   sample_name     = "ATAC_B",
#'   experiments     = list(
#'     ATAC = system.file("extdata", "h3k27me3_sampleB.bam", package = "chromcall")
#'   ),
#'   control_name    = NULL,
#'   genome_file     = genome_file,
#'   region_file     = region_file,
#'   window_size     = 10000,
#'   blacklist_file  = blacklist_file,
#'   expression_file = expr_file
#' )
#'
#' atac_resA <- test_region_counts(atacA)
#' atac_resB <- test_region_counts(atacB)
#'
#' # For interpretation, it is recommended that both samples are processed under the same mode
#' # (control vs no-control).
#' atac_cmp <- compare_samples(atac_resA, atac_resB, experiments = "ATAC", threshold = 0.05)
#'
#' out_file2 <- tempfile(fileext = ".tsv")
#' write_comparison_results(atac_cmp, out_file2)
#' read.table(out_file2, header = TRUE)
#'
#' @export
write_comparison_results <- function(x, file) {
  if (!methods::is(x, "GRanges")) {
    stop("Input must be a GRanges object from compare_samples()")
  }

  df <- as.data.frame(x)
  if ("strand" %in% names(df)) df$strand <- NULL
  if ("seqnames" %in% names(df)) names(df)[names(df) == "seqnames"] <- "chr"

  base_cols <- c("chr", "start", "end", "width")

  # Only treat *_expression as the per-sample expression columns added by compare_samples()
  expr_cols <- grep("_expression$", names(df), value = TRUE)

  if (length(expr_cols) >= 2) {

    # keep stable order (optional but recommended)
    expr_cols <- sort(expr_cols)

    sample1 <- expr_cols[1]
    sample2 <- expr_cols[2]
    sample1_prefix <- sub("_expression$", "", sample1)
    sample2_prefix <- sub("_expression$", "", sample2)

    get_columns <- function(prefix) {
      grep(
        paste0("^", prefix, "_.*_(padj|class|enrichment_score|z_score)$"),
        names(df),
        value = TRUE
      )
    }

    exp_ordered <- unique(sub(
      ".*_(.*?)_(padj|class|enrichment_score|z_score)$", "\\1",
      get_columns(sample1_prefix)
    ))

    ordered_cols <- c(
      base_cols,
      sample1,
      unlist(lapply(
        exp_ordered,
        function(e) paste0(sample1_prefix, "_", e,
                           c("_padj", "_class", "_enrichment_score", "_z_score"))
      )),
      sample2,
      unlist(lapply(
        exp_ordered,
        function(e) paste0(sample2_prefix, "_", e,
                           c("_padj", "_class", "_enrichment_score", "_z_score"))
      )),
      "log2FC_expression",
      paste0(exp_ordered, "_DeltaEnrichment"),
      paste0(exp_ordered, "_DeltaZscore")
    )

    ordered_cols <- intersect(ordered_cols, names(df))
    df <- df[, c(ordered_cols, setdiff(names(df), ordered_cols)), drop = FALSE]

  } else {
    df <- df[, c(base_cols, setdiff(names(df), base_cols)), drop = FALSE]
  }

  utils::write.table(
    df, file = file, sep = "\t", quote = FALSE,
    col.names = TRUE, row.names = FALSE
  )

  invisible(df)
}
