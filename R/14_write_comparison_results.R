#' Write chromcall 2-sample comparison results to file
#'
#' @description
#' Converts the result of [compare_samples] — a [`GRanges`] object containing
#' differential region-level statistics — into a `data.frame` and writes it to a
#' tab-delimited `.tsv` file. The `strand` column is removed (if present), and
#' the chromosome column is renamed to "chr" for consistency.
#'
#' @param x A [`GRanges`] object generated by [compare_samples]
#' @param file Output file path (should end in `.tsv`)
#'
#' @return A `data.frame` invisibly, also written to `file`
#'
#' @examples
#' # Load example files from package
#' genome_file <- system.file("extdata", "genome.txt", package = "chromcall")
#' region_file <- system.file("extdata", "example.bed", package = "chromcall")
#' blacklist_file <- system.file("extdata", "blacklist.bed", package = "chromcall")
#'
#' bam_dir <- system.file("extdata", package = "chromcall")
#' expr_file1 <- system.file("extdata", "expression_sampleA.bed", package = "chromcall")
#' expr_file2 <- system.file("extdata", "expression_sampleB.bed", package = "chromcall")
#'
#' # Define BAMs for two samples
#' experiments_1 <- list(
#'   H3K4me3 = file.path(bam_dir, "h3k4me3_sampleA.bam"),
#'   Control = file.path(bam_dir, "control_sampleA.bam")
#' )
#' experiments_2 <- list(
#'   H3K4me3 = file.path(bam_dir, "h3k4me3_sampleB.bam"),
#'   Control = file.path(bam_dir, "control_sampleB.bam")
#' )
#'
#' # Build chromcall samples (with expression files)
#' sample1 <- build_chromcall_sample(
#'   sample_name = "sampleA",
#'   experiments = experiments_1,
#'   control_name = "Control",
#'   genome_file = genome_file,
#'   region_file = region_file,
#'   window_size = 10000,
#'   blacklist_file = blacklist_file,
#'   expression_file = expr_file1
#' )
#'
#' sample2 <- build_chromcall_sample(
#'   sample_name = "sampleB",
#'   experiments = experiments_2,
#'   control_name = "Control",
#'   genome_file = genome_file,
#'   region_file = region_file,
#'   window_size = 10000,
#'   blacklist_file = blacklist_file,
#'   expression_file = expr_file2
#' )
#'
#' # Perform region-level analysis on each sample
#' result1 <- test_region_counts(sample1)
#' result2 <- test_region_counts(sample2)
#'
#' # Run two-sample comparison test
#' comparison <- compare_samples(result1, result2, experiment = "H3K4me3")
#'
#' # Export comparison result to file (includes expression columns if available)
#' out_file <- tempfile(fileext = ".tsv")
#' write_comparison_results(comparison, out_file)
#' read.table(out_file, header = TRUE)
#'
#' @export
write_comparison_results <- function(x, file) {
  if (!inherits(x, "GRanges")) {
    stop("Input must be a GRanges object from compare_samples()")
  }

  df <- as.data.frame(x)
  if ("strand" %in% names(df)) df$strand <- NULL
  if ("seqnames" %in% names(df)) names(df)[names(df) == "seqnames"] <- "chr"

  base_cols <- c("chr", "start", "end", "width")

  expr_cols <- grep("_expression$|^expression$", names(df), value = TRUE)

  if (length(expr_cols) >= 2) {
    sample1 <- expr_cols[1]
    sample2 <- expr_cols[2]
    sample1_prefix <- sub("_expression$", "", sample1)
    sample2_prefix <- sub("_expression$", "", sample2)

    get_columns <- function(prefix) {
      grep(paste0("^", prefix, "_.*_(padj|class|score)$"), names(df), value = TRUE)
    }

    exp_ordered <- unique(sub(".*_(.*?)_(padj|class|score)$", "\\1", get_columns(sample1_prefix)))

    ordered_cols <- c(
      base_cols,
      sample1,
      unlist(lapply(exp_ordered, function(e) paste0(sample1_prefix, "_", e, c("_padj", "_class", "_score", "_z")))),
      sample2,
      unlist(lapply(exp_ordered, function(e) paste0(sample2_prefix, "_", e, c("_padj", "_class", "_score", "_z")))),
      "log2FC_expression",
      paste0(exp_ordered, "_DeltaScore"),
      paste0(exp_ordered, "_DeltaZ")
    )

    ordered_cols <- intersect(ordered_cols, names(df))
    df <- df[, c(ordered_cols, setdiff(names(df), ordered_cols))]

  } else {
    df <- df[, c(base_cols, setdiff(names(df), base_cols))]
  }

  utils::write.table(df, file = file, sep = "\t", quote = FALSE,
                     col.names = TRUE, row.names = FALSE)

  invisible(df)
}
