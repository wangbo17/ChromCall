#' Write chromcall experiment results to file
#'
#' @description
#' Extracts region-level results for a specific experiment from a chromcall sample
#' (a [`RangedSummarizedExperiment`] object generated by [test_region_counts])
#' and writes them to a tab-delimited file. This includes raw counts, test statistics,
#' log2 fold changes, and significance classification.
#'
#' @param x A chromcall sample [`RangedSummarizedExperiment`] object
#' @param experiment_name A single experiment name to extract (must match `colnames(x)`)
#' @param file The output file path (tab-delimited `.tsv`)
#' @param alpha Significance threshold for adjusted p-values (default: 1e-5)
#'
#' @return A [`data.frame`] of region-level results (also written to file invisibly)
#'
#' @examples
#' # Load example files from package
#' genome_file <- system.file("extdata", "genome.txt", package = "chromcall")
#' region_file <- system.file("extdata", "example.bed", package = "chromcall")
#' blacklist_file <- system.file("extdata", "blacklist.bed", package = "chromcall")
#' expression_file <- system.file("extdata", "expression_tss.bed", package = "chromcall")
#'
#' # Example BAM files
#' bam_dir <- system.file("extdata", package = "chromcall")
#' experiments <- list(
#'   H3K27me3 = file.path(bam_dir, "h3k27me3_sampleA.bam"),
#'   H3K4me3  = file.path(bam_dir, "h3k4me3_sampleA.bam"),
#'   Control  = file.path(bam_dir, "control_sampleA.bam")
#' )
#'
#' # Build sample and run region-level test
#' sample <- build_chromcall_sample(
#'   sample_name = "sampleA",
#'   experiments = experiments,
#'   control_name = "Control",
#'   genome_file = genome_file,
#'   region_file = region_file,
#'   window_size = 10000,
#'   blacklist_file = blacklist_file,
#'   expression_file = expression_file
#' )
#' result <- test_region_counts(sample)
#'
#' # Write H3K4me3 results to file (includes expression column if present)
#' out_file <- tempfile(fileext = ".tsv")
#' write_experiment_results(result, "H3K4me3", out_file)
#' read.table(out_file, header = TRUE)
#'
#' @export
write_experiment_results <- function(x, experiment_name, file, alpha = 1e-5) {
  # Validate experiment name
  if (!(experiment_name %in% colnames(x))) {
    stop(sprintf("Experiment '%s' not found in sample. Available experiments: %s",
                 experiment_name, paste(colnames(x), collapse = ", ")))
  }

  gr <- SummarizedExperiment::rowRanges(x)

  GenomicRanges::mcols(gr)$counts_control <-
    SummarizedExperiment::assays(x)$counts[, S4Vectors::metadata(x)$control_name]
  GenomicRanges::mcols(gr)$counts_experiment <-
    SummarizedExperiment::assays(x)$counts[, experiment_name]
  GenomicRanges::mcols(gr)$logFC <-
    SummarizedExperiment::assays(x)$logFC[, experiment_name]
  GenomicRanges::mcols(gr)$modification_factor <-
    SummarizedExperiment::rowData(x)$modification_factor
  GenomicRanges::mcols(gr)$test_lambda <-
    SummarizedExperiment::assays(x)$lambda_t[, experiment_name]
  GenomicRanges::mcols(gr)$pvalue <-
    SummarizedExperiment::assays(x)$p_value[, experiment_name]
  GenomicRanges::mcols(gr)$padj <-
    SummarizedExperiment::assays(x)$p_adj[, experiment_name]

  GenomicRanges::mcols(gr)$significant <- factor(
    ifelse(SummarizedExperiment::assays(x)$p_adj[, experiment_name] <= alpha, "sig", "ns"),
    levels = c("ns", "sig")
  )

  df <- as.data.frame(gr, row.names = NULL)
  df$strand <- NULL

  if ("expression" %in% colnames(df)) {
    df <- df[, c(
      "seqnames", "start", "end", "width",
      "counts_control", "counts_experiment", "logFC",
      "modification_factor", "test_lambda", "pvalue", "padj",
      "expression",  # Include expression if present
      "significant"
    )]
  } else {
    df <- df[, c(
      "seqnames", "start", "end", "width",
      "counts_control", "counts_experiment", "logFC",
      "modification_factor", "test_lambda", "pvalue", "padj",
      "significant"
    )]
  }

  utils::write.table(df, file = file, sep = "\t", col.names = TRUE,
                     row.names = FALSE, quote = FALSE)

  invisible(df)
}
