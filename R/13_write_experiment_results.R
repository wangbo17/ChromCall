#' Write chromcall experiment results to file
#'
#' @description
#' Extracts region-level results for a specific experiment from a chromcall sample
#' (a [`RangedSummarizedExperiment`] object generated by [test_region_counts()])
#' and writes them to a tab-delimited file. This includes raw counts, test statistics,
#' log2 fold changes (if a control is present), and significance classification.
#'
#' In no-control mode (e.g., ATAC-seq), `counts_control` and `logFC` are returned as `NA`.
#'
#' @param x A chromcall sample [`RangedSummarizedExperiment`] object (after [test_region_counts()]).
#' @param experiment_name A single experiment name to extract (must match `colnames(x)`).
#' @param file The output file path (tab-delimited `.tsv`).
#' @param alpha Significance threshold for adjusted p-values (default: 1e-5).
#'
#' @return A [`data.frame`] of region-level results (also written to file invisibly).
#'
#' @examples
#' # Load example files from package
#' genome_file <- system.file("extdata", "genome.txt", package = "chromcall")
#' region_file <- system.file("extdata", "example.bed", package = "chromcall")
#' blacklist_file <- system.file("extdata", "blacklist.bed", package = "chromcall")
#' expression_file <- system.file("extdata", "expression_tss.bed", package = "chromcall")
#'
#' # Example BAM files
#' bam_dir <- system.file("extdata", package = "chromcall")
#' experiments <- list(
#'   H3K27me3 = file.path(bam_dir, "h3k27me3_sampleA.bam"),
#'   H3K4me3  = file.path(bam_dir, "h3k4me3_sampleA.bam"),
#'   Control  = file.path(bam_dir, "control_sampleA.bam")
#' )
#'
#' # Build sample and run region-level test
#' sample <- build_chromcall_sample(
#'   sample_name     = "sampleA",
#'   experiments     = experiments,
#'   control_name    = "Control",
#'   genome_file     = genome_file,
#'   region_file     = region_file,
#'   window_size     = 10000,
#'   blacklist_file  = blacklist_file,
#'   expression_file = expression_file
#' )
#' result <- test_region_counts(sample)
#'
#' # Write H3K4me3 results to file (includes expression column if present)
#' out_file <- tempfile(fileext = ".tsv")
#' write_experiment_results(result, "H3K4me3", out_file)
#' read.table(out_file, header = TRUE)
#'
#' ## No-control mode example (ATAC-seq-style)
#' # Note: we use a package example BAM here for demonstration only.
#' atac <- build_chromcall_sample(
#'   sample_name     = "ATAC_A",
#'   experiments     = list(
#'     ATAC = system.file("extdata", "h3k27me3_sampleA.bam", package = "chromcall")
#'   ),
#'   control_name    = NULL,
#'   genome_file     = genome_file,
#'   region_file     = region_file,
#'   window_size     = 10000,
#'   blacklist_file  = blacklist_file,
#'   expression_file = expression_file
#' )
#' atac_res <- test_region_counts(atac)
#'
#' out_file2 <- tempfile(fileext = ".tsv")
#' df_atac <- write_experiment_results(atac_res, "ATAC", out_file2)
#'
#' # Inspect exported table (no-control)
#' head(df_atac[, c("counts_control", "counts_experiment", "logFC", "score")])
#' # In no-control mode, counts_control and logFC are NA
#' unique(df_atac$counts_control)
#' unique(df_atac$logFC)
#'
#' @export
write_experiment_results <- function(x, experiment_name, file, alpha = 1e-5) {

  # Validate experiment name
  if (!(experiment_name %in% colnames(x))) {
    stop(sprintf(
      "Experiment '%s' not found in sample. Available experiments: %s",
      experiment_name, paste(colnames(x), collapse = ", ")
    ))
  }

  # Require test_region_counts outputs
  required_assays <- c("score", "lambda_t", "p_value", "p_adj", "z_pois", "counts")
  missing_assays <- setdiff(required_assays, SummarizedExperiment::assayNames(x))
  if (length(missing_assays) > 0) {
    stop(
      "write_experiment_results() requires the following assays: ",
      paste(required_assays, collapse = ", "),
      ". Missing: ", paste(missing_assays, collapse = ", "),
      ". Please run test_region_counts() first."
    )
  }

  md <- S4Vectors::metadata(x)
  ctrl <- md$control_name

  no_control <- isTRUE(md$no_control) ||
    is.null(ctrl) || is.na(ctrl) || !nzchar(ctrl) || !(ctrl %in% colnames(x))

  gr <- SummarizedExperiment::rowRanges(x)

  # counts_experiment always exists
  GenomicRanges::mcols(gr)$counts_experiment <-
    SummarizedExperiment::assays(x)$counts[, experiment_name]

  # counts_control + logFC depend on control
  if (!no_control) {
    GenomicRanges::mcols(gr)$counts_control <-
      SummarizedExperiment::assays(x)$counts[, ctrl]
    GenomicRanges::mcols(gr)$logFC <-
      SummarizedExperiment::assays(x)$logFC[, experiment_name]
  } else {
    GenomicRanges::mcols(gr)$counts_control <- NA_integer_
    GenomicRanges::mcols(gr)$logFC <- NA_real_
  }

  # shared outputs (exist for both modes after test_region_counts)
  GenomicRanges::mcols(gr)$score <-
    SummarizedExperiment::assays(x)$score[, experiment_name]
  GenomicRanges::mcols(gr)$test_lambda <-
    SummarizedExperiment::assays(x)$lambda_t[, experiment_name]
  GenomicRanges::mcols(gr)$pvalue <-
    SummarizedExperiment::assays(x)$p_value[, experiment_name]
  GenomicRanges::mcols(gr)$padj <-
    SummarizedExperiment::assays(x)$p_adj[, experiment_name]
  GenomicRanges::mcols(gr)$z_pois <-
    SummarizedExperiment::assays(x)$z_pois[, experiment_name]

  # modification_factor (exists in both modes; in no-control it is 1)
  if ("modification_factor" %in% colnames(SummarizedExperiment::rowData(x))) {
    GenomicRanges::mcols(gr)$modification_factor <-
      SummarizedExperiment::rowData(x)$modification_factor
  } else {
    GenomicRanges::mcols(gr)$modification_factor <- NA_real_
  }

  GenomicRanges::mcols(gr)$significant <- factor(
    ifelse(SummarizedExperiment::assays(x)$p_adj[, experiment_name] <= alpha, "sig", "ns"),
    levels = c("ns", "sig")
  )

  # Convert to data.frame
  df <- as.data.frame(gr, row.names = NULL)
  df$strand <- NULL

  # Define columns to export
  base_cols <- c(
    "seqnames", "start", "end", "width",
    "counts_control", "counts_experiment", "logFC", "score", "z_pois",
    "modification_factor", "test_lambda", "pvalue", "padj"
  )

  if ("expression" %in% colnames(df)) {
    df <- df[, c(base_cols, "expression", "significant")]
  } else {
    df <- df[, c(base_cols, "significant")]
  }

  # Write to file
  utils::write.table(
    df, file = file, sep = "\t",
    col.names = TRUE, row.names = FALSE, quote = FALSE
  )

  invisible(df)
}
